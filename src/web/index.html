<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AleaMaris Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .card{ background:rgba(255,255,255,.85); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); border-radius:1rem; box-shadow:0 10px 20px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.08); padding:1rem; }
    .btn{ border-radius:.75rem; padding:.5rem 1rem; font-weight:600; box-shadow:0 1px 2px rgba(0,0,0,.06); transition:transform .05s ease, background-color .15s ease, box-shadow .15s ease; display:inline-flex; align-items:center; gap:.5rem; }
    .btn:active{ transform:translateY(1px); box-shadow:0 0 0 rgba(0,0,0,0); }
    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-primary:hover{ background:#1d4ed8; }
    .btn-ghost{ background:#e2e8f0; color:#0f172a; }
    .btn-ghost:hover{ background:#cbd5e1; }
    .pill{ font-size:.75rem; padding:.125rem .5rem; border-radius:9999px; font-weight:600; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:1rem; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .spark { height: 40px; width: 100%; }
    /* Inputs visibly styled */
    input[type="text"], input[type="number"], input[type="file"], select, textarea {
      border:1px solid #cbd5e1; border-radius:.75rem; padding:.5rem .75rem; background:#fff; color:#0f172a;
    }
    input:focus, select:focus, textarea:focus {
      outline:2px solid #93c5fd; outline-offset:2px; border-color:#93c5fd;
    }
    /* Utility tweaks */
    .mt-1{ margin-top:.25rem; }
    .mt-2{ margin-top:.5rem; }
    .mb-3{ margin-bottom:.75rem; }
  </style>

</head>
<body class="bg-gradient-to-br from-sky-50 to-indigo-100 min-h-screen text-slate-800">
  <header class="max-w-6xl mx-auto px-4 pt-6 pb-2">
    <div class="flex items-center gap-4">
      <img src="aleamaris_logo.png" alt="AleaMaris" class="w-14 h-14 rounded-xl shadow">
      <div>
        <h1 class="text-2xl font-extrabold">AleaMaris Console</h1>
        <p class="text-sm text-slate-600">True Randomness from the Sea — RAW & ChaCha20-DRBG control panel</p>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10 space-y-6">

    <!-- Config -->
    <section class="card">
      <div class="flex flex-wrap items-end gap-3">
        <div class="grow">
          <label class="block text-sm font-medium">API Base URL</label>
          <input id="apiBase" class="w-full mt-1 rounded-xl border-slate-300" placeholder="http://localhost:8080" />
          <p class="text-xs text-slate-500 mt-1">Deja vacío para usar el mismo host (mismo origen).</p>
        </div>
        <button id="saveBase" class="btn btn-ghost">Save</button>
        <button id="ping" class="btn btn-primary">Ping /rng/stats</button>
        <span id="statusDot" class="pill bg-slate-200">idle</span>
      </div>
    </section>

    <!-- Stats -->
    <section class="card">
      <div class="flex items-center justify-between">
        <h2 class="font-bold text-lg">Live Stats</h2>
        <div class="flex items-center gap-2">
          <label class="text-sm">Auto-refresh</label>
          <input id="autoRefresh" type="checkbox" class="w-4 h-4">
          <select id="refreshMs" class="rounded-lg text-sm border-slate-300">
            <option value="1000">1s</option>
            <option value="2000">2s</option>
            <option value="5000" selected>5s</option>
            <option value="10000">10s</option>
          </select>
        </div>
      </div>
      <div class="grid-2 mt-3">
        <div>
          <div class="text-sm text-slate-600">RAW available</div>
          <div class="mono text-xl" id="rawAvail">—</div>
          <div class="w-full bg-slate-200 rounded mt-2">
            <div id="rawBar" class="bg-indigo-500 h-2 rounded" style="width:0%"></div>
          </div>
          <canvas id="spark" class="spark mt-2"></canvas>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="text-sm text-slate-600">Generated bytes (since reseed)</div>
            <div class="mono text-xl" id="genSince">—</div>
          </div>
          <div>
            <div class="text-sm text-slate-600">Reseed every</div>
            <div class="mono text-xl"><span id="reseedInt">—</span> bytes</div>
          </div>
          <div>
            <div class="text-sm text-slate-600">Reseed period</div>
            <div class="mono text-xl"><span id="reseedPeriod">—</span> s</div>
          </div>
          <div>
            <div class="text-sm text-slate-600">Reseed size</div>
            <div class="mono text-xl"><span id="reseedBytes">—</span> B</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RAW controls -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">RAW (pre-hash)</h2>
      <div class="grid-2">
        <div class="space-y-3">
          <div class="flex gap-2 items-end">
            <div class="grow">
              <label class="block text-sm font-medium">Read bytes</label>
              <input id="rawCount" type="number" value="512" min="1" max="4096" class="w-full mt-1 rounded-xl border-slate-300">
            </div>
            <button id="btnRawGet" class="btn btn-ghost">GET /trng/bytes</button>
            <button id="btnRawDownload" class="btn btn-primary">Download</button>
          </div>
          <textarea id="rawHex" rows="5" class="w-full mono rounded-xl border-slate-300" placeholder="hex preview…"></textarea>
        </div>
        <div class="space-y-3">
          <label class="block text-sm font-medium">Ingest RAW (append to queue)</label>
          <input id="ingFile" type="file" class="block w-full rounded-xl border-slate-300">
          <button id="btnIngest" class="btn btn-primary mt-2">POST /trng/ingest</button>
          <div id="ingResult" class="text-sm text-slate-600 mt-2">—</div>
        </div>
      </div>
    </section>

    <!-- DRBG controls -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">DRBG (ChaCha20)</h2>
<div class="mb-3 text-sm text-slate-600">Fast binary endpoints available: <code>/rng/u32.bin</code> (uint32 stream) and <code>/rng/bytes</code>.</div>
      <div class="grid-2">
        <div class="space-y-3">
          <div class="flex gap-2 items-end">
            <div class="grow">
              <label class="block text-sm font-medium">Bytes</label>
              <input id="rngCount" type="number" value="1024" min="1" max="1048576" class="w-full mt-1 rounded-xl border-slate-300">
            </div>
            <label class="text-sm flex items-center gap-2">
              <input id="rngReseed" type="checkbox" checked class="w-4 h-4"> reseed
            </label>
            <button id="btnRngBytes" class="btn btn-ghost">GET /rng/bytes</button>
            <button id="btnRngDownload" class="btn btn-primary">Download</button>
          </div>
          <textarea id="rngHex" rows="5" class="w-full mono rounded-xl border-slate-300" placeholder="hex preview…"></textarea>
        </div>
        <div class="space-y-3">
          <div class="flex gap-2 items-end">
            <div>
              <label class="block text-sm font-medium">min</label>
              <input id="intMin" type="number" value="0" class="w-24 mt-1 rounded-xl border-slate-300">
            </div>
            <div>
              <label class="block text-sm font-medium">max</label>
              <input id="intMax" type="number" value="36" class="w-24 mt-1 rounded-xl border-slate-300">
            </div>
            <div class="grow">
              <label class="block text-sm font-medium">count</label>
              <input id="intCount" type="number" value="10" min="1" max="100000" class="w-full mt-1 rounded-xl border-slate-300">
            </div>
            <button id="btnInts" class="btn btn-ghost">GET /rng/ints (JSON)</button>
            <button id="btnIntsBin" class="btn btn-primary">BIN (u32 LE)</button>
          </div>
          <textarea id="intsOut" rows="5" class="w-full mono rounded-xl border-slate-300" placeholder="[1, 5, 3, …]"></textarea>

          <label class="block text-sm font-medium mt-2">Manual reseed (octet-stream)</label>
          <input id="reseedFile" type="file" class="block w-full rounded-xl border-slate-300">
          <button id="btnReseed" class="btn btn-primary mt-2">POST /rng/reseed</button>
          <div id="reseedResult" class="text-sm text-slate-600 mt-2">—</div>
        </div>
      </div>
    
    <!-- High-throughput u32.bin -->
    <section class="card">
      <h2 class="font-bold text-lg mb-3">High-throughput u32 (binary)</h2>
      <div class="grid-2">
        <div class="space-y-3">
          <div class="flex gap-2 items-end">
            <div class="grow">
              <label class="block text-sm font-medium">Count (uint32)</label>
              <input id="u32Count" type="number" value="100000" min="1" max="25000000" class="w-full mt-1 rounded-xl border-slate-300">
            </div>
            <div>
              <label class="block text-sm font-medium">Endian</label>
              <select id="u32Endian" class="rounded-lg text-sm border-slate-300 mt-1">
                <option value="le" selected>little-endian</option>
                <option value="be">big-endian</option>
              </select>
            </div>
            <button id="btnU32Bin" class="btn btn-primary">GET /rng/u32.bin</button>
          </div>
          <div class="flex gap-6 mono">
            <div>Time: <span id="u32Time">—</span></div>
            <div>Size: <span id="u32Size">—</span></div>
            <div>Throughput: <span id="u32Thr">—</span></div>
          </div>
          <textarea id="u32Preview" rows="4" class="w-full mono rounded-xl border-slate-300" placeholder="first 16 integers…"></textarea>
        </div>
        <div class="space-y-3">
          <p class="text-sm text-slate-600">Tip: Use this endpoint from your client with <code>fetch(...).then(r=>r.arrayBuffer())</code> and reinterpret as <code>Uint32Array</code> for zero-copy parsing.</p>
          <pre class="mono text-xs bg-slate-100 rounded p-3 text-slate-800 overflow-auto">
const res = await fetch(base + '/rng/u32.bin?count=100000&endian=le');
const buf = await res.arrayBuffer();
const view = new DataView(buf);
const first = view.getUint32(0, true); // LE</pre>
        </div>
      </div>
    </section>
</section>

  </main>

  <script>
    // --- Helpers ---
    const $ = sel => document.querySelector(sel);
    const toHex = buf => [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    const download = (name, blob) => {
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    };
    const getBase = () => {
      const v = $('#apiBase').value.trim();
      return v || window.location.origin;
    };
    const setStatus = (txt, ok=true) => {
      const el = $('#statusDot');
      el.textContent = txt;
      el.className = 'pill ' + (ok ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700');
    };

    // --- Sparkline simple ---
    const spark = $('#spark'); const ctx = spark.getContext('2d');
    const sparkData = [];
    function pushSpark(v){
      sparkData.push(v); if(sparkData.length>80) sparkData.shift();
      const w = spark.width = spark.clientWidth, h = spark.height = spark.clientHeight;
      ctx.clearRect(0,0,w,h);
      if(!sparkData.length) return;
      const max = Math.max(...sparkData), min = Math.min(...sparkData);
      const norm = x => (max===min? 0.5 : (x-min)/(max-min));
      ctx.beginPath();
      sparkData.forEach((val,i)=>{
        const x = i*(w/(sparkData.length-1||1));
        const y = h - norm(val)*h;
        i? ctx.lineTo(x,y) : ctx.moveTo(x,y);
      });
      ctx.lineWidth = 2; ctx.strokeStyle = '#4f46e5'; ctx.stroke();
    }

    // --- API calls ---
    async function apiGet(path){
      const res = await fetch(getBase()+path);
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      return res;
    }
    async function apiPost(path, body){
      const res = await fetch(getBase()+path,{method:'POST', body});
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      return res;
    }

    async function refreshStats(){
      try{
        const r = await apiGet('/rng/stats'); const j = await r.json();
        $('#rawAvail').textContent = j.raw_available ?? '—';
        pushSpark(j.raw_available||0);
        const pct = Math.max(0, Math.min(100, (j.raw_available/(j.fill_high_wm||1))*100));
        $('#rawBar').style.width = pct.toFixed(1)+'%';
        $('#genSince').textContent = j.generated_bytes_since_last_reseed ?? '—';
        $('#reseedInt').textContent = j.reseed_interval_bytes ?? '—';
        $('#reseedPeriod').textContent = j.reseed_period_sec ?? '—';
        $('#reseedBytes').textContent = j.reseed_bytes ?? '—';
        setStatus('ok', true);
      }catch(e){
        setStatus('down', false);
      }
    }

    // --- RAW ---
    $('#btnRawGet').onclick = async ()=>{
      try{
        const n = Math.max(1, Math.min(4096, parseInt($('#rawCount').value||'0',10)));
        const r = await apiGet('/trng/bytes?count='+n);
        const buf = await r.arrayBuffer();
        $('#rawHex').value = toHexLimited(buf);
        refreshStats();
      }catch(e){ alert(e.message); }
    };
    $('#btnRawDownload').onclick = async ()=>{
      try{
        const n = Math.max(1, Math.min(4096, parseInt($('#rawCount').value||'0',10)));
        const r = await apiGet('/trng/bytes?count='+n);
        const blob = await r.blob();
        download('raw.bin', blob); refreshStats();
      }catch(e){ alert(e.message); }
    };
    $('#btnIngest').onclick = async ()=>{
      const f = $('#ingFile').files[0]; if(!f){ alert('Select a file'); return; }
      try{
        const r = await apiPost('/trng/ingest', f);
        const j = await r.json();
        $('#ingResult').textContent = `received=${j.received} dropped=${j.dropped} available=${j.available}`;
        refreshStats();
      }catch(e){ alert(e.message); }
    };

    // --- DRBG ---
    $('#btnRngBytes').onclick = async ()=>{
      try{
        const n = Math.max(1, Math.min(1048576, parseInt($('#rngCount').value||'0',10)));
        const reseed = $('#rngReseed').checked ? 'true':'false';
        const r = await apiGet(`/rng/bytes?count=${n}&reseed=${reseed}`);
        const buf = await r.arrayBuffer();
        $('#rngHex').value = toHexLimited(buf);
        refreshStats();
      }catch(e){ alert(e.message); }
    };
    $('#btnRngDownload').onclick = async ()=>{
      try{
        const n = Math.max(1, Math.min(1048576, parseInt($('#rngCount').value||'0',10)));
        const reseed = $('#rngReseed').checked ? 'true':'false';
        const r = await apiGet(`/rng/bytes?count=${n}&reseed=${reseed}`);
        const blob = await r.blob();
        download('rng.bin', blob); refreshStats();
      }catch(e){ alert(e.message); }
    };

    $('#btnInts').onclick = async ()=>{
      try{
        const mi = parseInt($('#intMin').value,10), ma = parseInt($('#intMax').value,10), c = parseInt($('#intCount').value,10);
        const r = await apiGet(`/rng/ints?min=${mi}&max=${ma}&count=${c}&reseed=true&fmt=json`);
        const j = await r.json();
        $('#intsOut').value = JSON.stringify(j.values || [], null, 2);
        refreshStats();
      }catch(e){ alert(e.message); }
    };
    $('#btnIntsBin').onclick = async ()=>{
      try{
        const mi = parseInt($('#intMin').value,10), ma = parseInt($('#intMax').value,10), c = parseInt($('#intCount').value,10);
        const r = await apiGet(`/rng/ints?min=${mi}&max=${ma}&count=${c}&reseed=true&fmt=bin`);
        const blob = await r.blob();
        download('ints_u32le.bin', blob); refreshStats();
      }catch(e){ alert(e.message); }
    };

    // Manual reseed
    $('#btnReseed').onclick = async ()=>{
      const f = $('#reseedFile').files[0]; if(!f){ alert('Select a file'); return; }
      try{
        const r = await apiPost('/rng/reseed', f);
        const j = await r.json();
        $('#reseedResult').textContent = `received=${j.received} status=${j.status}`;
        refreshStats();
      }catch(e){ alert(e.message); }
    };

    // Base URL handling
    $('#saveBase').onclick = ()=>{ localStorage.setItem('aleamaris_base', $('#apiBase').value.trim()); refreshStats(); };
    $('#ping').onclick = refreshStats;
    const saved = localStorage.getItem('aleamaris_base'); if(saved) $('#apiBase').value = saved;

    // Auto refresh
    let timer = null;
    const toggleAuto = ()=>{
      if($('#autoRefresh').checked){
        const ms = parseInt($('#refreshMs').value,10);
        timer && clearInterval(timer);
        timer = setInterval(refreshStats, ms);
      }else{
        timer && clearInterval(timer); timer = null;
      }
    };
    $('#autoRefresh').onchange = toggleAuto;
    $('#refreshMs').onchange = toggleAuto;

    
    // --- High-throughput u32.bin ---
    $('#btnU32Bin').onclick = async ()=>{
      try{
        const count = Math.max(1, Math.min(25_000_000, parseInt($('#u32Count').value||'0',10)));
        const endian = $('#u32Endian').value;
        const t0 = performance.now();
        const r = await apiGet(`/rng/u32.bin?count=${count}&endian=${endian}`);
        const buf = await r.arrayBuffer();
        const t1 = performance.now();
        // metrics
        const ms = (t1 - t0);
        $('#u32Time').textContent = ms.toFixed(2) + ' ms';
        const size = buf.byteLength;
        $('#u32Size').textContent = (size/1048576).toFixed(2) + ' MB';
        $('#u32Thr').textContent = ((size/1048576) / (ms/1000)).toFixed(2) + ' MB/s';
        // preview first 16 ints
        const view = new DataView(buf);
        const n = Math.min(16, Math.floor(buf.byteLength/4));
        const arr = [];
        const le = endian === 'le';
        for(let i=0;i<n;i++){ arr.push(view.getUint32(i*4, le)); }
        $('#u32Preview').value = arr.join(', ') + (count>n ? ' ...' : '');
        refreshStats();
      }catch(e){ alert(e.message); }
    };
    // Limit hex previews for performance
    function toHexLimited(buf, limit=1024){
      const bytes = new Uint8Array(buf, 0, Math.min(buf.byteLength, limit));
      return [...bytes].map(b=>b.toString(16).padStart(2,'0')).join(' ') + (buf.byteLength>limit ? ' ...' : '');
    }

    // First paint
    refreshStats();
  </script>
</body>
</html>
